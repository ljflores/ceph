tasks:
- install:
    branch: octopus
    exclude_packages:
      - ceph-volume
- print: "**** done install task..."
- print: "**** done start installing octopus cephadm ..."
- cephadm:
    image: quay.io/ceph/daemon-base:latest-octopus
    cephadm_branch: octopus
    cephadm_git_url: https://github.com/ceph/ceph
    conf:
      osd:
        #set config option for which cls modules are allowed to be loaded / used
        osd_class_load_list: "*"
        osd_class_default_list: "*"
    # deploy additional mons the "old" (octopus) way
    add_mons_via_daemon_add: true
    avoid_pacific_features: true
- print: "**** done end installing octopus cephadm ..."

- print: "**** done start cephadm.shell ceph config set mgr..."
- cephadm.shell:
    mon.a:
      - ceph config set mgr mgr/cephadm/use_repo_digest true --force
      - ceph config set mon mon_warn_on_insecure_global_id_reclaim false --force
      - ceph config set mon mon_warn_on_insecure_global_id_reclaim_allowed false --force
- print: "**** done end cephadm.shell ceph config set mgr..."

- print: "**** done start upgrade sequence"
- sequential:
   - print: "**** done start upgrade, wait"
   - cephadm.shell:
       env: [sha1]
       mon.a:
         - ceph config set global log_to_journald false --force
         - ceph orch upgrade start --image quay.ceph.io/ceph-ci/ceph:$sha1
         - while ceph orch upgrade status | jq '.in_progress' | grep true ; do ceph orch ps ; ceph versions ; sleep 30 ; done
         - ceph orch ps
         - ceph versions
         - ceph versions | jq -e '.overall | length == 1'
         - ceph versions | jq -e '.overall | keys' | grep $sha1
   - print: "**** done end upgrade, wait..."

   - print: "**** done start telemetry x..."
   - cephadm.shell:
       env: [sha1]
       mon.a:
         - ceph -s
         - ceph config get mgr mgr/telemetry/last_opt_revision
         - ceph telemetry preview
         - ceph telemetry preview-device
         - ceph telemetry channel ls
         - ceph telemetry collection ls
   - print: "**** done end telemetry x..."
- print: "**** done end upgrade sequence"
